<script>
  import { onMount } from "svelte";
  import { removeOutline, expandOutline, close as closeIcon } from "ionicons/icons";

  let isMinimized = false;
  export let isShowingInstructions;
  export let instructionsSource;
  let iframeHeight = "250px";

  function initDragElement() {
    let pos1 = 0,
      pos2 = 0,
      pos3 = 0,
      pos4 = 0;
    let popup = document.getElementById("movableDialog");
    let elmnt = null;
    let headerItem = document.getElementById("movableDialog-header");

    if (headerItem) {
      headerItem.parentPopup = popup;
      headerItem.onmousedown = dragMouseDown;
    }

    function dragMouseDown(e) {
      elmnt = this.parentPopup;

      e = e || window.event;
      // get the mouse cursor position at startup:
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      // call a function whenever the cursor moves:
      document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
      if (!elmnt) {
        return;
      }

      e = e || window.event;
      // calculate the new cursor position:
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      // set the element's new position:
      elmnt.style.top = elmnt.offsetTop - pos2 + "px";
      elmnt.style.left = elmnt.offsetLeft - pos1 + "px";
    }

    function closeDragElement() {
      /* stop moving when mouse button is released:*/
      document.onmouseup = null;
      document.onmousemove = null;
    }
  }

  function minimizeWindow() {
    const instructionsWindow = document.getElementById("movableDialog");
    const rootStyle = document.querySelector(":root");
    rootStyle.style.setProperty("--windowWidth", `${instructionsWindow.clientWidth}px`);
    isMinimized = !isMinimized;
  }

  function closeWindow() {
    isShowingInstructions = !isShowingInstructions;
  }

  onMount(() => {
    initDragElement();
  });

  function onMouseMove(event) {
    if (event.target.id === "movableDialog") {
      iframeHeight = `${event.target.clientHeight - 50}px`;
    }
  }
</script>

<div
  id="movableDialog"
  class={`movableDialog ${isMinimized ? "closed" : "open"}`}
  on:mousemove={onMouseMove}>
  <div
    id="movableDialog-header"
    class="movableDialog-header is-flex is-justify-content-space-between">
    <div>Instructions</div>
    <div class="is-flex">
      <button on:click={minimizeWindow} class="headerButtons mr-1">
        {#if isMinimized === false}
          <span title="Minimize"><ion-icon icon={removeOutline} /></span>
        {:else}
          <span title="Expand"><ion-icon icon={expandOutline} /></span>
        {/if}
      </button>
      <button on:click={closeWindow} class="headerButtons">
        <span title="Close"><ion-icon icon={closeIcon} /></span>
      </button>
    </div>
  </div>
  <div class={`${isMinimized ? "iframeClosed" : "iframeOpen"}`}>
    <iframe
      src={instructionsSource}
      width="100%"
      height={iframeHeight}
      title="instructions"
      id="instructionsFrame" />
  </div>
</div>

<style>
  .movableDialog {
    position: absolute;
    z-index: 999;
    border: 2px solid #b2b2b2;
  }

  .open {
    min-width: 500px;
    height: 300px;
    width: 500px;
    background-color: #e1e1e1;
    overflow-y: hidden;
    resize: both;
  }

  :root {
    --windowWidth: 500px;
  }
  .closed {
    background-color: #e1e1e100;
    overflow-y: hidden;
    resize: none;
    width: var(--windowWidth);
    height: 45px;
    border: none;
  }

  .iframeOpen {
    display: inherit;
  }

  .iframeClosed {
    display: none;
  }

  .movableDialog-header {
    padding-inline: 0.75rem;
    padding-block: 0.25rem;
    cursor: move;
    background-color: #0072bd;
    color: #fff;
  }

  .headerButtons {
    display: block;
    cursor: pointer;
    /* reset */
    padding: unset;
    border: unset;
    outline: unset;
    font: unset;
    color: unset;
    background: unset;
  }
  .headerButtons ion-icon {
    display: block;
  }
</style>
